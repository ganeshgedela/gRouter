{{- if .Values.natsdemosvc.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "grouter.fullname" . }}-natsdemosvc-config
  labels:
    app.kubernetes.io/name: {{ include "grouter.name" . }}-natsdemosvc
    app.kubernetes.io/instance: {{ .Release.Name }}
data:
  config.yaml: |
    app:
      name: natsdemosvc
    log:
      level: {{ .Values.natsdemosvc.logLevel }}
    web:
      enabled: true
      port: {{ .Values.natsdemosvc.service.port }}
    nats:
      enabled: true
      url: "nats://nats:4222"
    tracing:
      enabled: true
      service_name: natsdemosvc
      exporter: "otlp"
      endpoint: "http://jaeger:4318"
    services:
      {{- toYaml .Values.natsdemosvc.services | nindent 6 }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "grouter.fullname" . }}-natsdemosvc
  labels:
    app.kubernetes.io/name: {{ include "grouter.name" . }}-natsdemosvc
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  replicas: {{ .Values.natsdemosvc.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "grouter.name" . }}-natsdemosvc
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "grouter.name" . }}-natsdemosvc
        app.kubernetes.io/instance: {{ .Release.Name }}
        app: natsdemosvc
    spec:
      containers:
      - name: natsdemosvc
        image: "{{ .Values.natsdemosvc.image.repository }}:{{ .Values.natsdemosvc.image.tag }}"
        imagePullPolicy: {{ .Values.natsdemosvc.image.pullPolicy }}
        command: ["/app/natsdemosvc", "--config", "/app/config/config.yaml"]
        ports:
        - containerPort: {{ .Values.natsdemosvc.service.port }}
          name: http
        env:
        - name: GROUTER_CONFIG_PATH
          value: "/app/config/config.yaml"
        volumeMounts:
        - name: config
          mountPath: /app/config
      volumes:
      - name: config
        configMap:
          name: {{ include "grouter.fullname" . }}-natsdemosvc-config
---
apiVersion: v1
kind: Service
metadata:
  name: natsdemosvc # Fixed name
  labels:
    app.kubernetes.io/name: {{ include "grouter.name" . }}-natsdemosvc
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  type: {{ .Values.natsdemosvc.service.type }}
  ports:
  - port: {{ .Values.natsdemosvc.service.port }}
    targetPort: {{ .Values.natsdemosvc.service.port }}
  selector:
    app.kubernetes.io/name: {{ include "grouter.name" . }}-natsdemosvc
    app.kubernetes.io/instance: {{ .Release.Name }}
{{- end -}}
